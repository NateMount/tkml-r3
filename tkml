#! /usr/bin/env python3.10

import os, sys

def headless(funct):
	"""Used to return the execution of a function, it is assumed this function returns a function"""
	return funct()

def _help() -> None:
	"""Displays help text to stdout"""
	print("\n\t\033[38;2;0;0;0m\033[48;2;202;254;1m [tkml help]                                         \033[0m\n\t\033[38;2;202;254;1m\033[48;2;0;0;0m▌                                                   ▐\n\t\033[38;2;202;254;1m\033[48;2;0;0;0m▌ VERSION [0.0.1 in-dev]                            ▐\n\t\033[38;2;202;254;1m\033[48;2;0;0;0m▌ AUTHORS [NateMount, DeadPixil]                    ▐\n\t\033[38;2;202;254;1m\033[48;2;0;0;0m▌                                                   ▐\n\t\033[38;2;202;254;1m\033[48;2;0;0;0m▌ \033[38;2;0;0;0m\033[48;2;202;254;1m Usage \033[38;2;202;254;1m\033[48;2;0;0;0m ./tkml path [command] [flags]             ▐\n\t\033[38;2;202;254;1m\033[48;2;0;0;0m▌                                                   ▐\n\t\033[38;2;202;254;1m\033[48;2;0;0;0m▌ \033[38;2;0;0;0m\033[48;2;202;254;1m[ Commands ]\033[38;2;202;254;1m\033[48;2;0;0;0m                                      ▐\n\t\033[38;2;202;254;1m\033[48;2;0;0;0m▌        run - live runs the tkml code in the tkml  ▐\n\t\033[38;2;202;254;1m\033[48;2;0;0;0m▌              interpreter                          ▐\n\t\033[38;2;202;254;1m\033[48;2;0;0;0m▌                                                   ▐\n\t\033[38;2;202;254;1m\033[48;2;0;0;0m▌     render - creates a python executable file     ▐\n\t\033[38;2;202;254;1m\033[48;2;0;0;0m▌              from tkml source file                ▐\n\t\033[38;2;202;254;1m\033[48;2;0;0;0m▌                                                   ▐\n\t\033[38;2;202;254;1m\033[48;2;0;0;0m▌    compile - creates a windows executable file    ▐\n\t\033[38;2;202;254;1m\033[48;2;0;0;0m▌              from tkml sourve file                ▐\n\t\033[38;2;202;254;1m\033[48;2;0;0;0m▌                                                   ▐\n\t\033[38;2;202;254;1m\033[48;2;0;0;0m▌      debug - debugs a tkml source file            ▐\n\t\033[38;2;202;254;1m\033[48;2;0;0;0m▌                                                   ▐\n\t\033[38;2;202;254;1m\033[48;2;0;0;0m▌ \033[38;2;0;0;0m\033[48;2;202;254;1m[ Flags ]\033[38;2;202;254;1m\033[48;2;0;0;0m                                         ▐\n\t\033[38;2;202;254;1m\033[48;2;0;0;0m▌       form - sets format of tkml file             ▐\n\t\033[38;2;202;254;1m\033[48;2;0;0;0m▌              [yaml / xml / json]                  ▐\n\t\033[38;2;202;254;1m\033[48;2;0;0;0m▌                                                   ▐\n\t\033[38;2;0;0;0m\033[48;2;202;254;1m                                          [end help] \033[0m\n")

def _load_yaml(path:str) -> dict:
	"""Loads a yaml file into python dict"""
	import yaml
	try:
		with open(path, 'r') as f:
			return yaml.safe_load(f)
	except FileNotFoundError:
		print("\033[38;2;202;254;1mFile path not recognized")
		sys.exit()

def _load_xml(path:str):
	"""Loads a xml file into a python object"""
	raise NotImplementedError

@headless
def _read():
	"""Returns format in which document should be read"""
	return _load_yaml if 'form=yaml' in sys.argv else _load_xml


def _render(path:str) -> str:
	"""Reads in path to tkml file to render into python code"""
	data = _read(path)

def main() -> None:
	"""Main"""
	if len(sys.argv) == 1 or '--help' in sys.argv:
		_help()
		sys.exit()

	if 'render' in sys.argv:
		_render(sys.argv[1])
	
	elif 'compile' in sys.argv:
		_path = _render(sys.argv[1])

		if sys.platform in ('win32', 'cygwin', 'msys'):
			if 'pyinstaller' in os.listdir('C:\Python3\Scripts'):
				os.system('pyinstaller ' + _path)
			else:
				print('\033[38;2;202;254;1mPyinstaller not found \033[0m: install with pip3 install pyinstaller\033[0m')
				sys.exit()
		elif sys.platform in ('linux', 'linux2', 'darwin'):
			os.system('chmod +x ' + _path)
		else:
			print('\033[38;2;202;254;1mSystem not recognized\033[0m')
			sys.exit()

	else:
		_help()
		sys.exit()



if __name__ == '__main__':
	main()
